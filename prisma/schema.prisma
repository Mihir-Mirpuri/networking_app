generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                       String  @id @default(cuid())
  userId                   String
  type                     String
  provider                 String
  providerAccountId        String
  refresh_token            String?
  access_token             String?
  expires_at               Int?
  token_type               String?
  scope                    String?
  id_token                 String?
  session_state            String?
  refresh_token_expires_in Int?
  user                     User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id              String           @id @default(cuid())
  name            String?
  email           String?          @unique
  emailVerified   DateTime?
  image           String?
  classification  String?
  major           String?
  university      String?
  career          String?
  dailySendCount  Int              @default(0)
  lastSendDate    DateTime?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  accounts        Account[]
  emailTemplates  EmailTemplate[]
  scheduledEmails ScheduledEmail[]
  sendLogs        SendLog[]
  sessions        Session[]
  userCandidates  UserCandidate[]
  userResumes     UserResume[]
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Person {
  id               String          @id @default(cuid())
  fullName         String
  firstName        String?
  lastName         String?
  company          String
  role             String?
  linkedinUrl      String?
  email            String?
  emailStatus      EmailStatus?
  emailConfidence  Float?
  emailLastUpdated DateTime?
  city             String?
  state            String?
  country          String?
  educationSchool  String?
  educationDegree  String?
  educationField   String?
  educationYear    String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  sourceLinks      SourceLink[]
  userCandidates   UserCandidate[]

  @@unique([fullName, company])
  @@index([fullName, company])
  @@index([emailStatus])
}

model UserCandidate {
  id                   String           @id @default(cuid())
  userId               String
  personId             String
  email                String?
  emailStatus          EmailStatus      @default(MISSING)
  emailConfidence      Float?
  manualEmailConfirmed Boolean          @default(false)
  doNotShow            Boolean          @default(false)
  university           String?
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt
  emailDraft           EmailDraft?
  scheduledEmails      ScheduledEmail[]
  sendLogs             SendLog[]
  person               Person           @relation(fields: [personId], references: [id], onDelete: Cascade)
  user                 User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, personId])
  @@index([userId])
  @@index([personId])
  @@index([emailStatus])
  @@index([university])
  @@index([userId, doNotShow])
}

model SourceLink {
  id        String         @id @default(cuid())
  personId  String
  kind      SourceLinkKind
  url       String
  title     String
  snippet   String?
  domain    String?
  createdAt DateTime       @default(now())
  person    Person         @relation(fields: [personId], references: [id], onDelete: Cascade)

  @@unique([personId, url])
  @@index([personId])
  @@index([kind])
}

model UserResume {
  id                 String           @id @default(cuid())
  userId             String
  filename           String
  fileUrl            String
  fileSize           Int
  mimeType           String
  version            Int              @default(1)
  isActive           Boolean          @default(false)
  summary            String?
  summaryGeneratedAt DateTime?
  uploadedAt         DateTime         @default(now())
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  emailDrafts        EmailDraft[]
  emailTemplates     EmailTemplate[]
  scheduledEmails    ScheduledEmail[]
  sendLogs           SendLog[]
  user               User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, isActive])
}

model EmailTemplate {
  id           String       @id @default(cuid())
  userId       String
  name         String
  prompt       String
  isDefault    Boolean      @default(false)
  attachResume Boolean      @default(false)
  resumeId     String?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  emailDrafts  EmailDraft[]
  resume       UserResume?  @relation(fields: [resumeId], references: [id])
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, isDefault])
  @@index([resumeId])
}

model EmailDraft {
  id              String           @id @default(cuid())
  userCandidateId String           @unique
  templateId      String?
  subject         String
  body            String
  status          EmailDraftStatus @default(PENDING)
  userEdited      Boolean          @default(false)
  editedSubject   String?
  editedBody      String?
  attachResume    Boolean          @default(false)
  resumeId        String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  resume          UserResume?      @relation(fields: [resumeId], references: [id])
  template        EmailTemplate?   @relation(fields: [templateId], references: [id])
  userCandidate   UserCandidate    @relation(fields: [userCandidateId], references: [id], onDelete: Cascade)

  @@index([userCandidateId])
  @@index([templateId])
  @@index([status])
  @@index([resumeId])
}

model SendLog {
  id                   String         @id @default(cuid())
  userId               String
  userCandidateId      String?
  toEmail              String
  subject              String
  body                 String
  resumeAttached       Boolean        @default(false)
  resumeId             String?
  status               SendLogStatus
  errorMessage         String?
  gmailMessageId       String?        @unique
  gmailThreadId        String?
  sentAt               DateTime       @default(now())
  directRecipientEmail String?
  directRecipientName  String?
  resume               UserResume?    @relation(fields: [resumeId], references: [id])
  userCandidate        UserCandidate? @relation(fields: [userCandidateId], references: [id], onDelete: Cascade)
  user                 User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userCandidateId])
  @@index([status])
  @@index([sentAt])
  @@index([gmailMessageId])
  @@index([gmailThreadId])
}

model ScheduledEmail {
  id              String               @id @default(cuid())
  userId          String
  userCandidateId String
  toEmail         String
  subject         String
  body            String
  resumeId        String?
  scheduledFor    DateTime
  status          ScheduledEmailStatus @default(PENDING)
  errorMessage    String?
  sentAt          DateTime?
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  resume          UserResume?          @relation(fields: [resumeId], references: [id])
  userCandidate   UserCandidate        @relation(fields: [userCandidateId], references: [id], onDelete: Cascade)
  user            User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status, scheduledFor])
  @@index([userId])
  @@index([scheduledFor])
}

enum EmailStatus {
  MISSING
  UNVERIFIED
  VERIFIED
  MANUAL
}

enum SourceLinkKind {
  DISCOVERY
  RESEARCH
}

enum SendLogStatus {
  SUCCESS
  FAILED
}

enum EmailDraftStatus {
  PENDING
  APPROVED
  REJECTED
  SENT
}

enum ScheduledEmailStatus {
  PENDING
  SENT
  FAILED
  CANCELLED
}
